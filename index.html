<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>CRM Alinhatta - Sistema de Gest√£o de Leads</title>

    <!-- Favicon - m√∫ltiplos tamanhos para melhor visibilidade -->
    <link rel="icon" type="image/svg+xml" href="logo.svg" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="logo.svg">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="logo.svg">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="logo.svg">
    
    <!-- React 18 UMD -->
    <script defer src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (pra rodar JSX no browser) -->
    <script defer src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script defer src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- Supabase JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <!-- Tailwind (ok pra dev; prod √© outro passo) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fontes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        #root {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Configura√ß√£o Supabase -->
    <script>
        // Configurar chaves do Supabase
        window.__SUPABASE_URL__ = 'https://kiaoyzusvucimfefflws.supabase.co';
        window.__SUPABASE_ANON_KEY__ = 'sb_publishable_oDyFef_ctvsPKFg6ipCHcQ_3i8ISnrT';
    </script>
    
    <!-- Polyfill para window.storage -->
    <script>
        if (!window.storage) {
            window.storage = {
                get: async (key, shared = false) => {
                    try {
                        const value = localStorage.getItem(key);
                        if (value === null) return null;
                        return { value: value };
                    } catch (e) {
                        return null;
                    }
                },
                set: async (key, value, shared = false) => {
                    try {
                        localStorage.setItem(key, value);
                        return { key, value, shared };
                    } catch (e) {
                        console.error('Erro ao salvar:', e);
                        return null;
                    }
                }
            };
        }
    </script>
    
    <!-- Componente CRM - Carregar e processar -->
    <script>
        // Aguardar depend√™ncias estarem dispon√≠veis (scripts com defer carregam ap√≥s DOM)
        function waitForDependencies() {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 300; // 15 segundos (300 * 50ms)
                const checkInterval = setInterval(() => {
                    checkCount++;
                    const hasReact = typeof React !== 'undefined';
                    const hasReactDOM = typeof ReactDOM !== 'undefined';
                    const hasBabel = typeof Babel !== 'undefined';
                    const hasLucide = typeof lucide !== 'undefined';
                    
                    // Log a cada 20 verifica√ß√µes (1 segundo)
                    if (checkCount % 20 === 0) {
                        console.log(`Aguardando depend√™ncias... (${checkCount * 50}ms) React: ${hasReact}, ReactDOM: ${hasReactDOM}, Babel: ${hasBabel}, Lucide: ${hasLucide}`);
                    }
                    
                    if (hasReact && hasReactDOM && hasBabel && hasLucide) {
                        clearInterval(checkInterval);
                        console.log('‚úì Todas as depend√™ncias carregadas');
                        resolve();
                        return;
                    }
                    
                    // Timeout ap√≥s maxChecks
                    if (checkCount >= maxChecks) {
                        clearInterval(checkInterval);
                        const missing = [];
                        if (typeof React === 'undefined') missing.push('React');
                        if (typeof ReactDOM === 'undefined') missing.push('ReactDOM');
                        if (typeof Babel === 'undefined') missing.push('Babel');
                        if (typeof lucide === 'undefined') missing.push('lucide');
                        
                        if (missing.length > 0) {
                            const errorMsg = `Depend√™ncias n√£o carregadas ap√≥s ${maxChecks * 50}ms: ${missing.join(', ')}. ` +
                                           `Verifique sua conex√£o com a internet e recarregue a p√°gina.`;
                            console.error(errorMsg);
                            reject(new Error(errorMsg));
                        } else {
                            resolve();
                        }
                    }
                }, 50);
            });
        }
        
        // Executar apenas ap√≥s a p√°gina estar carregada
        async function loadComponent() {
            try {
                // Aguardar todas as depend√™ncias estarem dispon√≠veis
                await waitForDependencies();
                console.log('‚úì Depend√™ncias carregadas, processando componente...');
                
                // Carregar o arquivo
                const response = await fetch('alinhatta-crm.tsx');
                if (!response.ok) throw new Error('Falha ao carregar alinhatta-crm.tsx');
                
                let code = await response.text();
                
                // Remover export default se existir
                code = code.replace(/export\s+default\s+/g, '');
                
                // Verificar se Babel est√° dispon√≠vel
                if (typeof Babel === 'undefined') {
                    throw new Error('Babel n√£o foi carregado. Verifique sua conex√£o com a internet.');
                }
                
                // Transformar com Babel (TypeScript + React)
                console.log('Transformando c√≥digo com Babel...');
                const transformed = Babel.transform(code, {
                    filename: 'alinhatta-crm.tsx',
                    presets: [
                        ['react', { runtime: 'classic' }],
                        ['typescript', {}]
                    ],
                    plugins: []
                }).code;
                
                // Limpar exports problem√°ticos que o Babel pode criar
                let safeCode = transformed
                    .replace(/exports\.default\s*=\s*CRMAlinhatta;?/g, '')
                    .replace(/module\.exports\s*=\s*CRMAlinhatta;?/g, '');
                
                // Garantir que o componente seja definido globalmente (sempre no final)
                safeCode += '\n\n// Garantir exposi√ß√£o global\nif (typeof CRMAlinhatta !== "undefined") { window.CRMAlinhatta = CRMAlinhatta; }';
                
                console.log('Executando c√≥digo transformado...');
                
                // Executar o c√≥digo transformado
                const script = document.createElement('script');
                script.textContent = safeCode;
                script.onerror = (error) => {
                    console.error('Erro ao executar script:', error);
                };
                document.body.appendChild(script);
                
                // Verificar imediatamente ap√≥s executar
                setTimeout(() => {
                    console.log('Ap√≥s execu√ß√£o - CRMAlinhatta tipo:', typeof CRMAlinhatta);
                    console.log('Ap√≥s execu√ß√£o - window.CRMAlinhatta tipo:', typeof window.CRMAlinhatta);
                }, 50);
                
                // Aguardar um pouco e garantir que o componente esteja dispon√≠vel
                setTimeout(() => {
                    // Verificar se CRMAlinhatta foi definido (pode estar no escopo global ou window)
                    let componentFound = false;
                    
                    if (typeof CRMAlinhatta !== 'undefined') {
                        if (typeof CRMAlinhatta === 'function') {
                            window.CRMAlinhatta = CRMAlinhatta;
                            componentFound = true;
                            console.log('‚úì CRMAlinhatta encontrado no escopo global');
                        } else {
                            console.warn('CRMAlinhatta existe mas n√£o √© uma fun√ß√£o:', typeof CRMAlinhatta, CRMAlinhatta);
                        }
                    }
                    
                    // Verificar se j√° est√° em window (do c√≥digo TSX)
                    if (window.CRMAlinhatta && typeof window.CRMAlinhatta === 'function') {
                        componentFound = true;
                        console.log('‚úì CRMAlinhatta encontrado em window');
                    }
                    
                    if (!componentFound) {
                        console.error('‚úó CRMAlinhatta n√£o foi definido como fun√ß√£o v√°lida');
                        console.log('Vari√°veis dispon√≠veis:', Object.keys(window).filter(k => k.includes('CRM') || k.includes('Alin')));
                    }
                    
                    // Disparar evento para indicar que o componente foi carregado (ou n√£o)
                    window.dispatchEvent(new Event('crmComponentLoaded'));
                }, 300);
                
            } catch (error) {
                console.error('Erro ao carregar componente:', error);
                const errorHtml = 
                    '<div style="padding: 40px; text-align: center; font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto;">' +
                    '<h1 style="color: #dc2626; margin-bottom: 20px;">‚ö†Ô∏è Erro ao carregar o CRM</h1>' +
                    '<p style="color: #666; margin-bottom: 20px; font-size: 16px;">' + error.message + '</p>' +
                    '<div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: left;">' +
                    '<p style="font-weight: bold; margin-bottom: 10px; color: #92400e;">üí° Poss√≠veis solu√ß√µes:</p>' +
                    '<ul style="color: #78350f; line-height: 1.8; margin-left: 20px;">' +
                    '<li>Verifique sua conex√£o com a internet</li>' +
                    '<li>Recarregue a p√°gina (F5 ou Ctrl+R)</li>' +
                    '<li>Limpe o cache do navegador (Ctrl+Shift+Delete)</li>' +
                    '<li>Tente em outro navegador</li>' +
                    '</ul>' +
                    '</div>' +
                    '<button onclick="location.reload()" style="background: #1a7b60; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold;">üîÑ Recarregar P√°gina</button>' +
                    '</div>';
                document.getElementById('root').innerHTML = errorHtml;
            }
        }
        
        // Executar ap√≥s a p√°gina estar carregada
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadComponent);
        } else {
            loadComponent();
        }
    </script>
    
    <!-- Renderizar ap√≥s carregamento -->
    <script>
        // Aguardar o carregamento e processamento do componente pelo Babel
        let attempts = 0;
        const maxAttempts = 100; // 10 segundos no total
        
        function initApp() {
            attempts++;
            
            if (typeof window.CRMAlinhatta !== 'undefined') {
                try {
                    // Verificar se √© uma fun√ß√£o/componente v√°lido
                    if (typeof window.CRMAlinhatta !== 'function') {
                        console.error('CRMAlinhatta n√£o √© uma fun√ß√£o:', typeof window.CRMAlinhatta, window.CRMAlinhatta);
                        throw new Error('CRMAlinhatta deve ser uma fun√ß√£o/componente React');
                    }
                    
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(React.createElement(window.CRMAlinhatta));
                } catch (error) {
                    console.error('Erro ao renderizar:', error);
                    document.getElementById('root').innerHTML = 
                        '<div style="padding: 20px; text-align: center; color: red;">' +
                        '<h1>Erro ao renderizar o componente</h1>' +
                        '<p>' + error.message + '</p>' +
                        '</div>';
                }
            } else if (attempts < maxAttempts) {
                // Tentar novamente ap√≥s um pequeno delay
                setTimeout(initApp, 100);
            } else {
                // Timeout - mostrar mensagem com instru√ß√µes
                const isFileProtocol = window.location.protocol === 'file:';
                let errorMsg = '';
                
                if (isFileProtocol) {
                    errorMsg = 
                        '<div style="padding: 40px; text-align: center; font-family: Arial, sans-serif; max-width: 700px; margin: 50px auto;">' +
                        '<h1 style="color: #dc2626; margin-bottom: 20px;">‚ö†Ô∏è Arquivo aberto diretamente n√£o funciona</h1>' +
                        '<p style="color: #666; margin-bottom: 20px; font-size: 18px;">Por quest√µes de seguran√ßa, o navegador bloqueia o carregamento de arquivos quando abertos diretamente.</p>' +
                        '<div style="background: #f0f9ff; border: 2px solid #0ea5e9; padding: 25px; border-radius: 12px; text-align: left; margin: 30px 0;">' +
                        '<p style="font-weight: bold; font-size: 20px; margin-bottom: 15px; color: #0c4a6e;">üîß Como resolver:</p>' +
                        '<ol style="line-height: 2; color: #1e40af; font-size: 16px;">' +
                        '<li style="margin-bottom: 15px;">Feche esta janela</li>' +
                        '<li style="margin-bottom: 15px;">Execute o arquivo <strong style="background: #e0f2fe; padding: 4px 8px; border-radius: 4px;">START_SERVER.bat</strong> na pasta crm</li>' +
                        '<li style="margin-bottom: 15px;">Aguarde aparecer "Servidor iniciado"</li>' +
                        '<li style="margin-bottom: 15px;">Acesse <strong style="background: #e0f2fe; padding: 4px 8px; border-radius: 4px;">http://localhost:8000</strong> no navegador</li>' +
                        '</ol>' +
                        '</div>' +
                        '<div style="background: #1f2937; color: #10b981; padding: 20px; border-radius: 8px; font-family: monospace; text-align: left; margin-top: 20px;">' +
                        '<div style="margin-bottom: 10px;">üí° Alternativa (terminal):</div>' +
                        '<div style="margin-left: 20px;">cd crm</div>' +
                        '<div style="margin-left: 20px;">python server.py</div>' +
                        '</div>' +
                        '</div>';
                } else {
                    errorMsg = 
                        '<div style="padding: 20px; text-align: center;">' +
                        '<h1>Erro ao carregar o CRM</h1>' +
                        '<p>O componente n√£o foi carregado. Verifique:</p>' +
                        '<ul style="text-align: left; display: inline-block;">' +
                        '<li>Se o arquivo alinhatta-crm.tsx existe na mesma pasta</li>' +
                        '<li>Se h√° erros no console do navegador (F12)</li>' +
                        '</ul>' +
                        '</div>';
                }
                
                document.getElementById('root').innerHTML = errorMsg;
                console.error('CRMAlinhatta n√£o foi definido ap√≥s', maxAttempts, 'tentativas');
            }
        }
        
        // Aguardar evento de carregamento do componente OU tentar periodicamente
        window.addEventListener('crmComponentLoaded', () => {
            setTimeout(initApp, 100);
        });
        
        // Iniciar ap√≥s o carregamento da p√°gina (fallback)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => setTimeout(initApp, 500));
        } else {
            setTimeout(initApp, 500);
        }
    </script>
</body>
</html>